{
    "Id": "d166457a-1421-4731-b143-dd6766fb95d5",
    "Name": "Calculate Deployment Mode",
    "Description": "This step uses Octopus [System Variables](https://octopus.com/docs/projects/variables/system-variables) to calculate the deployment mode.  \n\n# Deployment Mode\nThe potential modes are:\n- **Deploy**: A newer version is being deployed to the target environment.  For example, `2021.1.4` is being deployed to **Production** to replace `2021.0.5`.\n- **Rollback**: An older version is being deployed to the target environment. For example, `2021.0.5` is being deployed to **Production** to replace `2021.1.4`.\n- **Redeploy**: The same version is being deployed to the target environment.  For example, `2021.1.4` is being deployed to **Production** which already has `2021.1.4`.\n\n**Please note**: This step template uses the release numbers to calculate the deployment mode.  It doesn't look at any packages.\n\n# Version Difference\nAfter calculating the deployment mode, the step template will calculate the version difference.  The potential options are:\n- **Identical**: No differences between the previous release and the current release were found.\n- **Major**: The first number (2021 in 2021.1.2.10) is different between the previous release and the current release.\n- **Minor**: The second number (1 in 2021.1.2.10) is different between the previous release and the current release.\n- **Build**: The third number (2 in 2021.1.2.10) is different between the previous release and the current release.\n- **Revision**: The fourth number (10 in 2021.1.2.10) is different between the previous release and the current release.\n\n# Manual or Automatic Trigger\nThe step template will also determine if the deployment was caused by a trigger or is a manual deployment.  Potential values are `True` (caused by a trigger) or `False` (manual deployment).\n\n# Output Variables\n\nThe following output variables will be set:\n- **DeploymentMode**: Will either be `Deploy`, `Rollback` or `Redeploy`.\n- **Trigger**: Will either be `True` or `False`.  Indicates if this deployment was caused by a trigger (scheduled or deployment target).\n- **VersionChange**: Will either be `Identical`, `Major`, `Minor`, `Build`, or `Revision`.\n\n## Variable Run Condition Output Variables\nTo make it easier to use, the step template will set a number of run condition output variables.  \n\n### Variable Run Condition Usage\nVariable Run Conditions will _always_ be evaluated.  Even if there is an error.  If the run condition comes back as **Truthy** it will run the step.  \n\nTo limit when the step runs, wrap the output variable with an if/then or unless clause:\n- **Always Run**: `#{Octopus.Action[Calculate Deployment Mode].Output.RunOnDeploy}`  \n- **Success**: Only run when previous steps succeeds `#{unless Octopus.Deployment.Error}#{Octopus.Action[Calculate Deployment Mode].Output.RunOnDeploy}#{/unless}`\n- **Failure**: Only run when previous steps fail `#{if Octopus.Deployment.Error}#{Octopus.Action[Calculate Deployment Mode].Output.RunOnDeploy}#{/if}`\n\n**Hint:** Replace **RunOnDeploy** from the above examples with one of the variables from below.\n\n### Deployment Mode Run Conditions\n- **RunOnDeploy**: Only run the step when the **DeploymentMode** is `Deploy`.\n- **RunOnRollback**: Only run the step when the **DeploymentMode** is `Rollback`.\n- **RunOnRedeploy**: Only run the step when the **DeploymentMode** is `Redeploy`.\n- **RunOnDeployOrRollback**: Only run the step when the **DeploymentMode** is`Deploy` or `Rollback`.\n- **RunOnDeployOrRedeploy**: Only run the step when the **DeploymentMode** is`Deploy` or `Redeploy`.\n- **RunOnRedeployOrRollback**: Only run the step when the **DeploymentMode** is `Redeploy` or `Rollback`.\n\n### Version Change Run Conditions\n- **RunOnMajorVersionChange**: Only run the step when the **VersionChange** is `Major`.\n- **RunOnMinorVersionChange**: Only run the step when the **VersionChange** is `Minor`.\n- **RunOnMajorOrMinorVersionChange**: Only run the step when the **VersionChange** is `Major` or `Minor`.\n- **RunOnBuildVersionChange**: Only run the step when the **VersionChange** is `Build`.\n- **RunOnRevisionVersionChange**: Only run the step when the **VersionChange** is `Revision`.\n\n# Usage \n\n**Important:** This step template is designed for deployment processes only.  Runbooks have no concept of deployments, redeployments, or rollbacks.\n\nThis step was designed to run on a worker (or the Octopus Server).  It can run on targets, but the output variables will all be the same; running on targets will do nothing but waste compute cycles.",
    "ActionType": "Octopus.Script",
    "Version": 5,
    "CommunityActionTemplateId": null,
    "Packages": [],
    "Properties": {
      "Octopus.Action.RunOnServer": "true",
      "Octopus.Action.Script.ScriptSource": "Inline",
      "Octopus.Action.Script.Syntax": "PowerShell",
      "Octopus.Action.Script.ScriptBody": "$currentReleaseNumber = $OctopusParameters[\"Octopus.Release.Number\"]\n$previousReleaseNumber = $OctopusParameters[\"Octopus.Release.CurrentForEnvironment.Number\"]\n$lastAttemptedReleaseNumber = $OctopusParameters[\"Octopus.Release.PreviousForEnvironment.Number\"]\n$stepName = $OctopusParameters[\"Octopus.Action.StepName\"]\n$triggerName = $OctopusParameters[\"Octopus.Deployment.Trigger.Name\"]\n\nWrite-Host \"The current release number is $currentReleaseNumber\"\nWrite-Host \"The last succesful release to this environment was $previousReleaseNumber\"\nWrite-Host \"The last release that was attempted on this environment was $lastAttemptedReleaseNumber\"\nWrite-Host \"The deployment name is $deploymentName\"\n\nif ($previousReleaseNumber -like \"*-*\")\n{\n\t$previousReleaseNumber = $previousReleaseNumber.SubString(0, $previousReleaseNumber.IndexOf(\"-\"))\n}\n\nif ($currentReleaseNumber -like \"*-*\")\n{\n\t$currentReleaseNumber = $currentReleaseNumber.SubString(0, $currentReleaseNumber.IndexOf(\"-\"))\n}\n\nif ($lastAttemptedReleaseNumber -like \"*-*\")\n{\n\t$lastAttemptedReleaseNumber = $lastAttemptedReleaseNumber.SubString(0, $lastAttemptedReleaseNumber.IndexOf(\"-\"))\n}\n\nWrite-Host \"The non-pre release tag previous version for the environment was $previousReleaseNumber\"\nWrite-Host \"The non-pre release tag current release number is $currentReleaseNumber\"\nWrite-Host \"The non-pre release tag of the last attempted version for the environment was $lastAttemptedReleaseNumber\"\n\n$currentVersion = [System.Version]$currentReleaseNumber\n$previousVersion = [System.Version]$previousReleaseNumber\n$lastAttemptedVersion = [System.Version]$lastAttemptedReleaseNumber\n\n$differentVersions = $false\n$versionToCompare = $previousVersion\nif ($currentVersion -gt $previousVersion)\n{\n\tWrite-Host \"The current release number $currentReleaseNumber is greater than the previous successful release number $previousReleaseNumber.\"\n\tif ($currentVersion -lt $lastAttemptedVersion)\n    {\n    \tWrite-Host \"The current release number $currentReleaseNumber is less than the last attempted release number $lastAttemptedReleaseNumber.  Setting deployment mode to rollback.\"\n\t    $deploymentMode = \"Rollback\"\n        $versionToCompare = $lastAttemptedVersion\n    }\n    else\n    {\n    \tWrite-Host \"The current release number $curentReleaseNumber is greater than the last attempted release number $lastAttemptedReleaseNumber.  Setting deployment mode to deploy.\"\n        $deploymentMode = \"Deploy\"\n    }\n}\nelseif ($currentVersion -lt $previousVersion)\n{\n\tWrite-Host \"The current release number $currentReleaseNumber is less than the previous successful release number $previousReleaseNumber.  Setting deployment mode to rollback.\"\n    $deploymentMode = \"Rollback\"\n    $differentVersions = $true\n}\nelseif ($currentVersion -lt $lastAttemptedVersion)\n{\n\tWrite-Host \"The current release number $currentReleaseNumber is less than the last attempted release number $lastAttemptedReleaseNumber.  Setting the deployment mode to rollback.\"\n    $deploymentMode = \"Rollback\"\n    $differentVersions = $true\n    $versionToCompare = $lastAttemptedVersion\n}\nelse\n{\n\tWrite-Host \"The current release number $currentReleaseNumber matches the previous release number $previousReleaseNumber.  Setting deployment mode to redeployment.\"\n    $deploymentMode = \"Redeploy\"\n}\n\n$differenceKind = \"Identical\"\nif ($differentVersions)\n{\n\tif ($currentVersion.Major -ne $versionToCompare.Major)\n    {\n    \tWrite-Host \"$currentReleaseNumber is a major version change from $versionToCompare\"\n    \t$differenceKind = \"Major\"\n    }\n    elseif ($currentVersion.Minor -ne $versionToCompare.Minor)\n    {\n    \tWrite-Host \"$currentReleaseNumber is a minor version change from $versionToCompare\"\n    \t$differenceKind = \"Minor\"\n    }\n    elseif ($currentVersion.Build -ne $versionToCompare.Build)\n    {\n    \tWrite-Host \"$currentReleaseNumber is a build version change from $versionToCompare\"\n    \t$differenceKind = \"Build\"\n    }\n    elseif ($currentVersion.Revision -ne $versionToCompare.Revision)\n    {\n    \tWrite-Host \"$currentReleaseNumber is a revision version change from $versionToCompare\"\n    \t$differenceKind = \"Revision\"\n    }\n}\n\n$trigger = $false\nif ([string]::IsNullOrWhiteSpace($triggerName) -eq $false)\n{\n\tWrite-Host \"This task was created by trigger $triggerName.\"\n    $trigger = $true\n}\n\nSet-OctopusVariable -Name \"DeploymentMode\" -Value $deploymentMode\nSet-OctopusVariable -Name \"VersionChange\" -Value $differenceKind\nSet-OctopusVariable -Name \"Trigger\" -Value $trigger\n\nWrite-Highlight @\"\nOutput Variables Created:\n   \t- Octopus.Action[$($stepName)].Output.DeploymentMode - Set to '$deploymentMode'\n    - Octopus.Action[$($stepName)].Output.VersionChange - Set to '$differenceKind'\n    - Octopus.Action[$($stepName)].Output.Trigger - Set to '$trigger'\n\nDeployment Mode Run Conditions Output Variables:\n   \t- Octopus.Action[$($stepName)].Output.RunOnRollback\n    - Octopus.Action[$($stepName)].Output.RunOnDeploy\n    - Octopus.Action[$($stepName)].Output.RunOnRedeploy\n    - Octopus.Action[$($stepName)].Output.RunOnDeployOrRollback\n    - Octopus.Action[$($stepName)].Output.RunOnDeployOrRedeploy\n    - Octopus.Action[$($stepName)].Output.RunOnRollbackOrRedeploy\n\nVersion Change Run Conditions Output Variables:\n   \t- Octopus.Action[$($stepName)].Output.RunOnMajorVersionChange\n    - Octopus.Action[$($stepName)].Output.RunOnMinorVersionChange\n    - Octopus.Action[$($stepName)].Output.RunOnMajorOrMinorVersionChange\n    - Octopus.Action[$($stepName)].Output.RunOnBuildVersionChange\n    - Octopus.Action[$($stepName)].Output.RunOnRevisionVersionChange\n  \nVariable run conditions are always evaluated, even if there is an error.  Use the following examples to control when your step runs.  Replace RunOnDeploy from below examples with one of the variables from above.  \n- Always Run: `#{Octopus.Action[$stepName].Output.RunOnDeploy}`  \n- Success: Only run when previous steps succeeds `##{unless Octopus.Deployment.Error}#{Octopus.Action[$stepName].Output.RunOnDeploy}##{/unless}`\n- Failure: Only run when previous steps fail `##{if Octopus.Deployment.Error}#{Octopus.Action[$stepName].Output.RunOnDeploy}##{/if}`\n\n\"@\n\n$runOnRollback = \"#{if Octopus.Action[$($stepName)].Output.DeploymentMode == \"\"Rollback\"\"}True#{else}False#{/if}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnRollback' so you can use it as a run condition\"\nWrite-Verbose $runOnRollback\nSet-OctopusVariable -Name \"RunOnRollback\" -Value $runOnRollback\n\n$runOnDeploy = \"#{if Octopus.Action[$($stepName)].Output.DeploymentMode == \"\"Deploy\"\"}True#{else}False#{/if}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnDeploy' so you can use it as a run condition\"\nWrite-Verbose $runOnDeploy\nSet-OctopusVariable -Name \"RunOnDeploy\" -Value $runOnDeploy\n\n$runOnRedeploy = \"#{if Octopus.Action[$($stepName)].Output.DeploymentMode == \"\"Redeploy\"\"}True#{else}False#{/if}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnRedeploy' so you can use it as a run condition\"\nWrite-Verbose $runOnRedeploy\nSet-OctopusVariable -Name \"RunOnRedeploy\" -Value $runOnRedeploy\n\n$runOnDeployOrRollback = \"#{if Octopus.Action[$($stepName)].Output.DeploymentMode != \"\"Redeploy\"\"}True#{else}False#{/if}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnDeployOrRollback' so you can use it as a run condition\"\nWrite-Verbose $runOnDeployOrRollback\nSet-OctopusVariable -Name \"RunOnDeployOrRollback\" -Value $runOnDeployOrRollback\n\n$runOnDeployOrRedeploy = \"#{if Octopus.Action[$($stepName)].Output.DeploymentMode != \"\"Rollback\"\"}True#{else}False#{/if}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnDeployOrRedeploy' so you can use it as a run condition\"\nWrite-Verbose $runOnDeployOrRedeploy\nSet-OctopusVariable -Name \"RunOnDeployOrRedeploy\" -Value $runOnDeployOrRedeploy\n\n$runOnRedeployOrRollback = \"#{if Octopus.Action[$($stepName)].Output.DeploymentMode != \"\"Deploy\"\"}True#{else}False#{/if}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnRedeployOrRollback' so you can use it as a run condition\"\nWrite-Verbose $runOnRedeployOrRollback\nSet-OctopusVariable -Name \"RunOnRedeployOrRollback\" -Value $runOnRedeployOrRollback\n\n$runOnMajorVersionChange = \"#{if Octopus.Action[$($stepName)].Output.VersionChange == \"\"Major\"\"}True#{else}False#{/if}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnMajorVersionChange' so you can use it as a run condition\"\nWrite-Verbose $runOnMajorVersionChange\nSet-OctopusVariable -Name \"RunOnMajorVersionChange\" -Value $runOnMajorVersionChange\n\n$runOnMinorVersionChange = \"#{if Octopus.Action[$($stepName)].Output.VersionChange == \"\"Minor\"\"}True#{else}False#{/if}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnMinorVersionChange' so you can use it as a run condition\"\nWrite-Verbose $runOnMinorVersionChange\nSet-OctopusVariable -Name \"RunOnMinorVersionChange\" -Value $runOnMinorVersionChange\n\n$runOnMajorOrMinorVersionChange = \"#{if Octopus.Action[$stepName].Output.VersionChange == \"\"Major\"\"}True#{else}#{if Octopus.Action[$stepName].Output.VersionChange == \"\"Minor\"\"}True#{else}False#{/if}#{/if}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnMajorOrMinorVersionChange' so you can use it as a run condition\"\nWrite-Verbose $runOnMajorOrMinorVersionChange\nSet-OctopusVariable -Name \"RunOnMajorOrMinorVersionChange\" -Value $runOnMajorOrMinorVersionChange\n\n$runOnBuildVersionChange = \"#{if Octopus.Action[$($stepName)].Output.VersionChange == \"\"Build\"\"}True#{else}False#{/if}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnBuildVersionChange' so you can use it as a run condition\"\nWrite-Verbose $runOnBuildVersionChange\nSet-OctopusVariable -Name \"RunOnBuildVersionChange\" -Value $runOnBuildVersionChange\n\n$runOnRevisionVersionChange = \"#{if Octopus.Action[$($stepName)].Output.VersionChange == \"\"Revision\"\"}True#{else}False#{/if}\"\nWrite-Host \"Setting the output variable 'Octopus.Action[$($stepName)].Output.RunOnRevisionVersionChange' so you can use it as a run condition\"\nWrite-Verbose $runOnRevisionVersionChange\nSet-OctopusVariable -Name \"RunOnRevisionVersionChange\" -Value $runOnRevisionVersionChange"
    },
    "Parameters": [],
    "$Meta": {
      "ExportedAt": "2021-11-02T13:48:09.120Z",
      "OctopusVersion": "2021.1.7738",
      "Type": "ActionTemplate"
    },
    "LastModifiedBy": "BobJWalker",
    "Category": "octopus"
  }